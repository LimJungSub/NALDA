<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<title>Data Stream</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="stylesheet" href="./uPlot.min.css">
	<link rel="stylesheet" href="./custom_style.css">
</head>

<body>
	<script src="./uPlot.iife.js"></script>
	<div id="graph-wrap"></div>
	<!-- <div id="data-info"></div> -->

	<script>
		let testData = [
			Array.from({ length: 200 }, (_, i) => i),
			Array.from({ length: 200 }, () => null),
		];


		// QML에서 데이터를 받을 함수
		window.receiveData = function (data) {
			console.log("HTML에서 받은 데이터:", data);
			console.log("데이터 타입:", typeof data);
			console.log("배열 길이:", data.length);
			console.log("첫 번째 요소:", data[0]);

			testData[0] = testData[0].slice(1).concat([testData[0].at(-1) + 1]);
			testData[1] = testData[1].slice(1).concat([data[1]]);

			// 데이터 정보를 표시할 DOM 요소에 내용 업데이트
			var dataInfo = document.getElementById("data-info");
			dataInfo.innerHTML = "받은 데이터: " + JSON.stringify(data);
		};

		function getSize() {
			let graphWrapper = document.getElementById('graph-wrap');
			return {
				width: graphWrapper.clientWidth,
				height: 300
			}
		}

		function makeChart() {
			let interval = 100;

			let makeFmt = suffix => (u, v, sidx, didx) => {
				if (didx == null) {
					let d = u.data[sidx];
					v = d[d.length - 1];
				}

				return v == null ? null : v.toFixed(1) + suffix;
			};

			const opts = {
				title: "xacc / yacc / zacc (mG)",
				width: '100%',
				height: 300,
				cursor: {
					drag: {
						setScale: false,
					}
				},
				select: {
					show: false,
				},
				series: [
					{
						value: (u, v, sidx, didx) => {
							if (didx == null) {
								let d = u.data[sidx];
								v = d[d.length - 1];
							}

							return v;
						}
					},
					{
						label: "CPU",
						scale: "%",
						value: makeFmt('%'),
						stroke: "red",
					},

				],
				axes: [
					{},
					{
						scale: '%',
						values: (u, vals, space) => vals.map(v => +v.toFixed(1) + "%"),
					},
				],
				scales: {
					x: {
						time: false,
					}
				}
			};

			let uplot1 = new uPlot(opts, testData, document.getElementById('graph-wrap'));

			setInterval(function () {
				uplot1.setData(testData);
			}, interval);

			// Resize handling
			uplot1.setSize(getSize()); // 최초 1회 트리거
			window.addEventListener("resize", e => {
				uplot1.setSize(getSize());
			});
		}

		makeChart();
	</script>
</body>

</html>